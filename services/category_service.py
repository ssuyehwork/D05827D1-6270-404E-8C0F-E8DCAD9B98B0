# application/services/category_service.pyfrom typing import List, Optional, Dict, Anyfrom domain.entities import Categoryfrom infrastructure.repositories.category_repository import CategoryRepositoryfrom infrastructure.repositories.idea_repository import IdeaRepositoryclass CategoryService:    def __init__(self, category_repository: CategoryRepository, idea_repository: IdeaRepository):        self._category_repo = category_repository        self._idea_repo = idea_repository    def get_all_categories(self) -> List[Dict]:        """获取所有分类"""        categories = self._category_repo.get_all()        return [self._category_to_dict(cat) for cat in categories]        def _category_to_dict(self, cat: Category) -> Dict:        return {            'id': cat.id,            'name': cat.name,            'parent_id': cat.parent_id,            'color': cat.color,            'sort_order': cat.sort_order,            'preset_tags': cat.preset_tags        }            def create_category(self, name: str, parent_id: Optional[int] = None) -> None:        """创建分类"""        if not name.strip():            raise ValueError("分类名称不能为空")        self._category_repo.add(name, parent_id)            def rename_category(self, category_id: int, new_name: str) -> None:        """重命名分类"""        if not new_name.strip():            raise ValueError("分类名称不能为空")        self._category_repo.rename(category_id, new_name)            def delete_category(self, category_id: int) -> None:        """删除分类"""        # 先解绑所有笔记        cursor = self._idea_repo.connection.cursor()        cursor.execute('UPDATE ideas SET category_id=NULL WHERE category_id=?', (category_id,))        self._idea_repo.connection.commit()                # 删除分类        self._category_repo.delete(category_id)            def set_category_color(self, category_id: int, color: str) -> None:        """设置分类颜色（包括子分类和笔记）"""        cursor = self._category_repo.connection.cursor()        try:            # 查找所有子分类            find_ids_query = """                WITH RECURSIVE category_tree(id) AS (                    SELECT ?                    UNION ALL                    SELECT c.id FROM categories c JOIN category_tree ct ON c.parent_id = ct.id                )                SELECT id FROM category_tree;            """            cursor.execute(find_ids_query, (category_id,))            all_ids = [row[0] for row in cursor.fetchall()]            if not all_ids:                return            placeholders = ','.join('?' * len(all_ids))            # 更新笔记颜色            update_ideas_query = f"UPDATE ideas SET color = ? WHERE category_id IN ({placeholders})"            cursor.execute(update_ideas_query, (color, *all_ids))            # 更新分类颜色            update_categories_query = f"UPDATE categories SET color = ? WHERE id IN ({placeholders})"            cursor.execute(update_categories_query, (color, *all_ids))            self._category_repo.connection.commit()        except Exception as e:            self._category_repo.connection.rollback()            raise e    def set_preset_tags(self, category_id: int, tags_str: str) -> None:        """设置预设标签"""        self._category_repo.set_preset_tags(category_id, tags_str)    def get_preset_tags(self, category_id: int) -> str:        """获取预设标签"""        return self._category_repo.get_preset_tags(category_id)    def apply_preset_tags_to_items(self, category_id: int, tags_list: List[str]) -> None:        """应用预设标签到分类下所有笔记"""        if not tags_list:            return                cursor = self._idea_repo.connection.cursor()        cursor.execute('SELECT id FROM ideas WHERE category_id=? AND is_deleted=0', (category_id,))        items = cursor.fetchall()                for (iid,) in items:            self._idea_repo.add_tags_to_ideas([iid], tags_list)    def build_category_tree(self) -> List[Category]:        """构建分类树"""        categories = self._category_repo.get_all()        category_map = {cat.id: cat for cat in categories}                tree = []        for cat in categories:            if cat.parent_id in category_map:                parent = category_map[cat.parent_id]                parent.children.append(cat)            else:                tree.append(cat)        return tree    def save_category_order(self, update_list: List[Dict[str, Any]]) -> None:        """保存分类顺序"""        self._category_repo.save_order(update_list)