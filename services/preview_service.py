# -*- coding: utf-8 -*-# services/preview_service.pyimport osfrom PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QLabel, QTextEdit,                              QWidget, QDesktopWidget, QShortcut, QPushButton,                              QGraphicsDropShadowEffect, QSizePolicy, QStyle)from PyQt5.QtCore import Qt, QPoint, QSize, QEvent, QRectfrom PyQt5.QtGui import QPixmap, QKeySequence, QFont, QColor, QPainter, QIcon, QPalettefrom core.config import COLORS, STYLES# 关键修改 1: 引入支持语法高亮的 RichTextEditfrom ui.components.rich_text_edit import RichTextEditclass ScalableImageLabel(QLabel):    """    智能图片标签：    支持随窗口大小变化自动缩放图片，保持比例并居中。    """    def __init__(self, parent=None):        super().__init__(parent)        self._original_pixmap = None        self.setSizePolicy(QSizePolicy.Ignored, QSizePolicy.Ignored)        self.setAlignment(Qt.AlignCenter)        self.setMinimumSize(200, 200)    def set_pixmap(self, pixmap):        self._original_pixmap = pixmap        self.update()    def paintEvent(self, event):        if not self._original_pixmap or self._original_pixmap.isNull():            text = "无法加载图片"            painter = QPainter(self)            painter.setPen(QColor("#666"))            painter.drawText(self.rect(), Qt.AlignCenter, text)            return        painter = QPainter(self)        painter.setRenderHint(QPainter.Antialiasing)        painter.setRenderHint(QPainter.SmoothPixmapTransform)                # 计算缩放后的尺寸，保持纵横比        scaled_size = self._original_pixmap.size().scaled(self.size(), Qt.KeepAspectRatio)                # 计算居中位置        x = (self.width() - scaled_size.width()) // 2        y = (self.height() - scaled_size.height()) // 2                # 绘制        target_rect = QRect(x, y, scaled_size.width(), scaled_size.height())        painter.drawPixmap(target_rect, self._original_pixmap)class PreviewDialog(QDialog):    """    增强版预览窗口：支持拖动、最大化、最小化、自适应缩放、多图切换    """    def __init__(self, mode, data_list, parent=None):        """        :param mode: 'text' 或 'gallery' (图片集合)        :param data_list: 数据列表。如果是文本则是 [text_str]，如果是画廊则是 [path1, path2, blob...]        """        super().__init__(parent)        # 普通无边框窗口        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Window)        self.setAttribute(Qt.WA_TranslucentBackground)        self.setAttribute(Qt.WA_DeleteOnClose)                 # 状态变量        self.mode = mode        self.data_list = data_list        self.current_index = 0        self._drag_pos = None                self._init_ui()        self._setup_shortcuts()        self._load_current_content()    def _init_ui(self):        # 1. 根布局        root_layout = QVBoxLayout(self)        root_layout.setContentsMargins(10, 10, 10, 10)                # 2. 主容器        self.container = QWidget()        self.container.setObjectName("PreviewContainer")        # 关键修改 2: 注入 STYLES['dialog'] 以获取全局滚动条和基础样式        self.container.setStyleSheet(f"""            QWidget#PreviewContainer {{                background-color: {COLORS['bg_dark']};                border: 1px solid {COLORS['bg_light']};                border-radius: 8px;            }}        """ + STYLES.get('dialog', ''))                shadow = QGraphicsDropShadowEffect(self)        shadow.setBlurRadius(20)        shadow.setXOffset(0)        shadow.setYOffset(5)        shadow.setColor(QColor(0, 0, 0, 150))        self.container.setGraphicsEffect(shadow)                root_layout.addWidget(self.container)                # 3. 内容布局        self.main_layout = QVBoxLayout(self.container)        self.main_layout.setContentsMargins(0, 0, 0, 0)        self.main_layout.setSpacing(0)                # 4. 标题栏        self.title_bar = self._create_title_bar()        self.main_layout.addWidget(self.title_bar)                # 5. 内容显示区域        self.content_area = QWidget()        self.content_layout = QVBoxLayout(self.content_area)        self.content_layout.setContentsMargins(15, 5, 15, 5)        self.main_layout.addWidget(self.content_area, 1)                # 初始化显示控件        self.text_edit = None        self.image_label = None                if self.mode == 'text':            self._init_text_widget()        else:            self._init_image_widget()                    # 6. 底部控制栏 (仅多图模式显示)        self.control_bar = QWidget()        ctrl_layout = QHBoxLayout(self.control_bar)        ctrl_layout.setContentsMargins(20, 5, 20, 10)                self.btn_prev = QPushButton("◀ 上一张")        self.btn_next = QPushButton("下一张 ▶")                btn_style = f"""            QPushButton {{                background-color: {COLORS['bg_mid']};                border: 1px solid {COLORS['bg_light']};                color: #ddd;                padding: 6px 15px;                border-radius: 4px;            }}            QPushButton:hover {{ background-color: {COLORS['primary']}; border-color: {COLORS['primary']}; color: white; }}        """        self.btn_prev.setStyleSheet(btn_style)        self.btn_next.setStyleSheet(btn_style)                self.btn_prev.clicked.connect(self._prev_image)        self.btn_next.clicked.connect(self._next_image)                ctrl_layout.addWidget(self.btn_prev)        ctrl_layout.addStretch()                # 提示文字        hint = QLabel("按 [Space] 关闭 | [←/→] 切换")        hint.setStyleSheet(f"color: {COLORS['text_sub']}; font-size: 11px;")        ctrl_layout.addWidget(hint)                ctrl_layout.addStretch()        ctrl_layout.addWidget(self.btn_next)                self.main_layout.addWidget(self.control_bar)                # 如果只有一张图或文本模式，隐藏控制栏        if len(self.data_list) <= 1:            self.control_bar.hide()    def _init_text_widget(self):        # 关键修改 3: 使用 RichTextEdit 替代 QTextEdit，支持语法高亮        self.text_edit = RichTextEdit()        self.text_edit.setReadOnly(True)        # self.text_edit.setFont(QFont("Microsoft YaHei", 12)) # 字体通常由 RichTextEdit 内部管理或通过样式表设置                # 关键修改 4: 强制深色样式 (三重保险: 样式表 + Palette)        self.text_edit.setStyleSheet(f"""            QTextEdit {{                background-color: {COLORS['bg_dark']};                border: none;                color: #eee;                selection-background-color: {COLORS['primary']}60;                padding: 10px;                font-family: "Microsoft YaHei", Consolas, "Courier New", monospace;                font-size: 14px;            }}        """)                # 设置底层调色板，防止样式表失效时回退到白色        p = self.text_edit.palette()        p.setColor(QPalette.Base, QColor(COLORS['bg_dark']))        p.setColor(QPalette.Text, QColor('#eee'))        self.text_edit.setPalette(p)        self.content_layout.addWidget(self.text_edit)        self.resize(1130, 740)    def _init_image_widget(self):        self.image_label = ScalableImageLabel()        self.content_layout.addWidget(self.image_label)        self.resize(1130, 740)    def _create_title_bar(self):        title_bar = QWidget()        title_bar.setFixedHeight(36)        title_bar.setStyleSheet(f"""            QWidget {{                background-color: {COLORS['bg_mid']};                border-top-left-radius: 8px;                border-top-right-radius: 8px;                border-bottom: 1px solid {COLORS['bg_light']};            }}        """)                layout = QHBoxLayout(title_bar)        layout.setContentsMargins(10, 0, 10, 0)                self.title_label = QLabel("预览")        self.title_label.setStyleSheet("font-weight: bold; color: #ddd; border: none; background: transparent;")        layout.addWidget(self.title_label)                layout.addStretch()                btn_style = "QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-family: Arial; font-size: 14px; } QPushButton:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }"                btn_min = QPushButton("─")        btn_min.setFixedSize(28, 28)        btn_min.setStyleSheet(btn_style)        btn_min.clicked.connect(self.showMinimized)                self.btn_max = QPushButton("□")        self.btn_max.setFixedSize(28, 28)        self.btn_max.setStyleSheet(btn_style)        self.btn_max.clicked.connect(self._toggle_maximize)                btn_close = QPushButton("×")        btn_close.setFixedSize(28, 28)        btn_close.setStyleSheet("QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-size: 16px; } QPushButton:hover { background-color: #e74c3c; color: white; }")        btn_close.clicked.connect(self.close)                layout.addWidget(btn_min)        layout.addWidget(self.btn_max)        layout.addWidget(btn_close)        return title_bar    def _load_current_content(self):        """核心方法：根据 index 加载数据"""        if not self.data_list: return                current_data = self.data_list[self.current_index]        total = len(self.data_list)                # 更新标题        if self.mode == 'text':            self.title_label.setText("📝 文本预览")            # 关键修改 5: 使用 setPlainText 保持源码格式，配合 RichTextEdit 实现高亮            if self.text_edit:                self.text_edit.setPlainText(str(current_data))        else:            self.title_label.setText(f"🖼️ 图片预览 [{self.current_index + 1}/{total}]")            self._show_image(current_data)                    # 居中窗口 (仅在第一次显示时)        if not self.isVisible():            self._center_on_screen()    def _show_image(self, data):        """显示单张图片，支持路径或二进制数据"""        pixmap = QPixmap()                if isinstance(data, bytes):            pixmap.loadFromData(data)        elif isinstance(data, str) and os.path.exists(data):            pixmap.load(data)                self.image_label.set_pixmap(pixmap)    def _center_on_screen(self):        screen = QDesktopWidget().screenNumber(QDesktopWidget().cursor().pos())        center = QDesktopWidget().screenGeometry(screen).center()        self.move(center.x() - self.width() // 2, center.y() - self.height() // 2)    def _toggle_maximize(self):        if self.isMaximized():            self.showNormal()            self.btn_max.setText("□")            self.layout().setContentsMargins(10, 10, 10, 10)        else:            self.showMaximized()            self.btn_max.setText("❐")            self.layout().setContentsMargins(0, 0, 0, 0)    def _prev_image(self):        if self.current_index > 0:            self.current_index -= 1            self._load_current_content()    def _next_image(self):        if self.current_index < len(self.data_list) - 1:            self.current_index += 1            self._load_current_content()    def _setup_shortcuts(self):        QShortcut(QKeySequence(Qt.Key_Escape), self, self.close)        QShortcut(QKeySequence(Qt.Key_Space), self, self.close)                # 左右键切换图片        QShortcut(QKeySequence(Qt.Key_Left), self, self._prev_image)        QShortcut(QKeySequence(Qt.Key_Right), self, self._next_image)    # --- 拖动逻辑 ---    def mousePressEvent(self, event):        if event.button() == Qt.LeftButton and event.y() < 50:            self._drag_pos = event.globalPos() - self.frameGeometry().topLeft()            event.accept()        else:            super().mousePressEvent(event)    def mouseMoveEvent(self, event):        if event.buttons() == Qt.LeftButton and self._drag_pos:            if not self.isMaximized():                self.move(event.globalPos() - self._drag_pos)                event.accept()        else:            super().mouseMoveEvent(event)    def mouseReleaseEvent(self, event):        self._drag_pos = None        super().mouseReleaseEvent(event)            def mouseDoubleClickEvent(self, event):        if event.y() < 50:            self._toggle_maximize()class PreviewService:    def __init__(self, db_manager, parent_window):        self.db = db_manager        self.parent = parent_window        self.current_dialog = None    def toggle_preview(self, selected_ids):        if self.current_dialog and self.current_dialog.isVisible():            self.current_dialog.close()            self.current_dialog = None            return        if not selected_ids: return        if len(selected_ids) != 1:            self._show_tooltip('⚠️ 只能预览单个项目')            return                    idea_id = list(selected_ids)[0]        self._open_preview(idea_id)    def _open_preview(self, idea_id):        idea = self.db.get_idea(idea_id, include_blob=True)        if not idea: return                # 字段: 2=content, 10=item_type, 11=data_blob        content = idea[2]        try:            item_type = idea[10] if len(idea) > 10 else 'text'            data_blob = idea[11] if len(idea) > 11 else None        except IndexError:            item_type = 'text'            data_blob = None                    mode = 'text'        data_list = []                # 1. 数据库 Blob 图片        if item_type == 'image' and data_blob:            mode = 'gallery'            data_list = [data_blob]                # 2. 文本内容分析 (核心修复逻辑)        elif content:            # 检查是否包含分号 (多文件路径特征)            potential_paths = content.split(';')            valid_images = []            img_exts = {'.png', '.jpg', '.jpeg', '.bmp', '.gif', '.webp', '.ico', '.svg', '.tif'}                        for p in potential_paths:                p = p.strip()                if p and os.path.exists(p):                    ext = os.path.splitext(p)[1].lower()                    if ext in img_exts:                        valid_images.append(p)                        if valid_images:                mode = 'gallery'                data_list = valid_images            else:                mode = 'text'                data_list = [content]        else:            self._show_tooltip('⚠️ 内容为空')            return                    # 创建窗口        self.current_dialog = PreviewDialog(mode, data_list, self.parent)        self.current_dialog.finished.connect(self._on_dialog_closed)        self.current_dialog.show()    def _on_dialog_closed(self):        self.current_dialog = None    def _show_tooltip(self, msg):        if hasattr(self.parent, '_show_tooltip'):            self.parent._show_tooltip(msg, 1500)