# -*- coding: utf-8 -*-# ui/action_popup.pyfrom PyQt5.QtWidgets import QWidget, QHBoxLayout, QPushButton, QLabel, QGraphicsDropShadowEffect, QFramefrom PyQt5.QtCore import Qt, pyqtSignal, QTimer, QPoint, QSize, QRectFfrom PyQt5.QtGui import (QCursor, QColor, QPainter, QLinearGradient,                          QPainterPath, QPen, QBrush, QFont, QPixmap)from core.config import COLORSfrom ui.common_tags import CommonTagsfrom core.logger import get_loggerlogger = get_logger('ActionPopup')class ActionPopup(QWidget):    """    复制成功后在鼠标附近弹出的快捷操作条    架构优化：使用静态 QLabel 替代自定义 PaintEvent，杜绝绘图闪退，大幅提升性能。    """    request_favorite = pyqtSignal(int, bool)    request_tag_toggle = pyqtSignal(int, str, bool)     request_manager = pyqtSignal()     def __init__(self, parent=None):         super().__init__(parent)        self.current_idea_id = None        self.is_favorited = False                 self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.Tool)        self.setAttribute(Qt.WA_TranslucentBackground)        self.setAttribute(Qt.WA_ShowWithoutActivating)                self._init_ui()                self.hide_timer = QTimer(self)        self.hide_timer.setSingleShot(True)        self.hide_timer.timeout.connect(self._animate_hide)    def _generate_icon_pixmap(self):        """生成高质量抗锯齿图标 (24x24)"""        size = 128 # 依然使用大图绘制，保证细节        pixmap = QPixmap(size, size)        pixmap.fill(Qt.transparent)                p = QPainter(pixmap)        p.setRenderHint(QPainter.Antialiasing)        p.setRenderHint(QPainter.HighQualityAntialiasing)        p.setRenderHint(QPainter.SmoothPixmapTransform)                p.translate(size / 2, size / 2)        p.scale(1.1, 1.1)         # --- 绘图逻辑 ---        w, h = 56, 76        # 页厚 (灰白)        p.setBrush(QColor(210, 210, 210))         p.setPen(Qt.NoPen)        p.drawRoundedRect(QRectF(-w/2+5, -h/2+4, w, h), 3, 3)        # 封面 (Mocha Theme)        grad = QLinearGradient(-w, -h, w, h)        grad.setColorAt(0, QColor(70, 40, 35))           grad.setColorAt(1, QColor(100, 60, 50))          p.setBrush(grad)        p.drawRoundedRect(QRectF(-w/2, -h/2, w, h), 3, 3)        # 书签        p.setBrush(QColor(160, 30, 40))        p.drawRect(QRectF(w/2 - 14, -h/2, 8, h))        # 钢笔        p.rotate(-45)        p.translate(0, -8)         w_pen, h_pen = 14, 48         body_grad = QLinearGradient(-w_pen/2, 0, w_pen/2, 0)        body_grad.setColorAt(0.0, QColor(200, 70, 80))         body_grad.setColorAt(1.0, QColor(80, 10, 20))         path_body = QPainterPath()        path_body.addRoundedRect(QRectF(-w_pen/2, -h_pen/2, w_pen, h_pen), 6, 6)        p.setBrush(body_grad)        p.drawPath(path_body)        path_tip = QPainterPath()        tip_h = 16        path_tip.moveTo(-w_pen/2 + 3, h_pen/2)        path_tip.lineTo(w_pen/2 - 3, h_pen/2)        path_tip.lineTo(0, h_pen/2 + tip_h)        path_tip.closeSubpath()        p.setBrush(QColor(255, 220, 100))        p.drawPath(path_tip)        p.setBrush(QColor(255, 215, 0))        p.drawRect(QRectF(-w_pen/2, h_pen/2 - 5, w_pen, 5))                p.end()        # 缩放到 24x24，这是标准工具栏图标尺寸        return pixmap.scaled(24, 24, Qt.KeepAspectRatio, Qt.SmoothTransformation)    def _init_ui(self):        self.container = QWidget(self)        self.container.setStyleSheet(f"""            QWidget {{                background-color: #1F1F1F;                border: 1px solid #383838;                border-radius: 16px;            }}        """)                layout = QHBoxLayout(self.container)        # 舒适的专业布局：上下 4px, 左右 10px        layout.setContentsMargins(10, 4, 10, 4)        # 间距 8px        layout.setSpacing(8)                # 1. 笔记本图标 (使用 QLabel 显示 Pixmap)        self.lbl_icon = QLabel()        self.lbl_icon.setFixedSize(24, 24)        self.lbl_icon.setPixmap(self._generate_icon_pixmap())        self.lbl_icon.setStyleSheet("background: transparent; border: none;")        layout.addWidget(self.lbl_icon)                # 2. 分割线        line = QFrame()        line.setFixedWidth(1)        line.setFixedHeight(16)        line.setStyleSheet("background-color: #444; border: none;")        layout.addWidget(line)        # 3. 收藏按钮        self.btn_fav = QPushButton("☆")        self.btn_fav.setToolTip("收藏 / 取消")        self.btn_fav.setCursor(Qt.PointingHandCursor)        self.btn_fav.setFixedSize(24, 24)         self.btn_fav.setStyleSheet(f"""            QPushButton {{                background: transparent; color: #777; border: none;                 font-size: 18px; padding-bottom: 3px; margin: 0px;            }}            QPushButton:hover {{ color: #BBB; }}        """)        self.btn_fav.clicked.connect(self._on_fav_clicked)        layout.addWidget(self.btn_fav)        # 4. 常用标签条        self.common_tags_bar = CommonTags()        self.common_tags_bar.tag_toggled.connect(self._on_tag_toggled)        self.common_tags_bar.manager_requested.connect(self._on_manager_clicked)        self.common_tags_bar.refresh_requested.connect(self._adjust_size_dynamically)                layout.addWidget(self.common_tags_bar)                shadow = QGraphicsDropShadowEffect(self)        shadow.setBlurRadius(20)        shadow.setXOffset(0)        shadow.setYOffset(5)        shadow.setColor(QColor(0, 0, 0, 100))        self.container.setGraphicsEffect(shadow)    def _adjust_size_dynamically(self):        if self.isVisible():            self.container.adjustSize()            self.resize(self.container.size() + QSize(10, 10))    def show_at_mouse(self, idea_id):        logger.debug(f"Popup Show: ID={idea_id}")        self.current_idea_id = idea_id                try:            self.common_tags_bar.reload_tags()            self.common_tags_bar.reset_selection()                        self.is_favorited = False            self._update_fav_style()                        self.container.adjustSize()            self.resize(self.container.size() + QSize(10, 10))                        cursor_pos = QCursor.pos()            x = cursor_pos.x() + 15            y = cursor_pos.y() + 15                        self.move(x, y)            self.show()            self.hide_timer.start(3500)        except Exception as e:            logger.error(f"Popup Show Error: {e}")    def _on_fav_clicked(self):        self.is_favorited = not self.is_favorited        if self.current_idea_id:            try:                self._update_fav_style()                self.request_favorite.emit(self.current_idea_id, self.is_favorited)                self.hide_timer.start(2500)            except Exception as e:                logger.error(f"Fav Error: {e}")    def _update_fav_style(self):        if self.is_favorited:            self.btn_fav.setText("★")            self.btn_fav.setStyleSheet(f"""                QPushButton {{                    background: transparent; color: #FFD700; border: none;                     font-size: 18px; padding-bottom: 3px; margin: 0px;                }}                QPushButton:hover {{ color: #FFEA00; }}            """)        else:            self.btn_fav.setText("☆")            self.btn_fav.setStyleSheet(f"""                QPushButton {{                    background: transparent; color: #777; border: none;                     font-size: 18px; padding-bottom: 3px; margin: 0px;                }}                QPushButton:hover {{ color: #BBB; }}            """)    def _on_tag_toggled(self, tag_name, checked):        logger.info(f"Tag Toggled: {tag_name} -> {checked}")        if self.current_idea_id:            try:                self.request_tag_toggle.emit(self.current_idea_id, tag_name, checked)                self.hide_timer.start(2500)             except Exception as e:                logger.error(f"Tag Toggle Error: {e}")    def _on_manager_clicked(self):        self.request_manager.emit()        self.hide()     def _animate_hide(self):        self.hide()    def enterEvent(self, event):        self.hide_timer.stop()        super().enterEvent(event)    def leaveEvent(self, event):        self.hide_timer.start(1500)        super().leaveEvent(event)    def closeEvent(self, event):        self.hide_timer.stop()        super().closeEvent(event)